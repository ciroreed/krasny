var krasny=function(underscore,jquery){var SELF_KRASNY=this;var HTTP={get:"GET",post:"POST",put:"PUT","delete":"DELETE"};var models={};var views={};var config={};var modelData=[];var viewTemplates=[];var getResource=function(uid,resource,callback){restAdapter(uid,resource,undefined,callback)};var restAdapter=function(uid,uri,body,call,args,recursiveFn,callback){var req=uri.split(":");var httpverb;if(req[0]===HTTP.delete||req[0]===HTTP.put||req[0]===HTTP.post)httpverb=req[0];req=req.pop();jquery.ajax({url:req,method:httpverb||HTTP.get,data:body||{},success:function(data){call(uid,data);if(typeof recursiveFn!=="undefined")recursiveFn(args,call,callback)}})};var retrieveSync=function(resourceArray,call,callback){if(resourceArray.length){var resource=resourceArray.shift();restAdapter(resource.uid,resource.uri,undefined,call,resourceArray,retrieveSync,callback)}else callback()};var View=function(prop){var SELF_VIEW=this;if(typeof prop.uid==="undefined")throw new Error("View must have `uid` property");underscore.each(prop,function(v,k){SELF_VIEW[k]=v});SELF_VIEW.init=function(html){SELF_VIEW.invalidate(html);SELF_VIEW.html=html};SELF_VIEW.listen=function(){underscore.each(SELF_VIEW.events||{},function(handler,ev){ev=ev.split(" ");handler=handler.split(" ");var context=SELF_VIEW.el.find(handler[1]);SELF_VIEW.el.find(ev[1]).on(ev[0],function(e){if(handler[1]==="target")context=e.target;SELF_VIEW[handler[0]](e,jquery(context),SELF_VIEW.el)})})};SELF_VIEW.invalidate=function(html){SELF_VIEW.el=jquery(SELF_VIEW.root);var compiledHtml=underscore.template(html||SELF_VIEW.html);if(SELF_VIEW.scope)compiledHtml=compiledHtml({scope:models[SELF_VIEW.scope].scope});jquery(SELF_VIEW.root).html(compiledHtml);if(!html)listen()};SELF_VIEW.render=function(){render(SELF_VIEW)}};var Model=function(prop){var SELF_MODEL=this;var scopedView;SELF_MODEL.cfg=prop;if(typeof SELF_MODEL.cfg.uid==="undefined")throw new Error("Model must have `uid` property");SELF_MODEL.uid=SELF_MODEL.cfg.uid;var invalidateScopedView=function(){scopedView=scopedView||underscore.find(views,underscore.matcher({scope:SELF_MODEL.uid}));if(scopedView){scopedView.invalidate()}};SELF_MODEL.construct=function(fresh){var instance=function(){var inst=this;inst.uid=SELF_MODEL.uid;inst.attr={};inst.get=function(k){return inst.attr[k]};inst.set=function(k,v){inst.attr[k]=v};underscore.each(SELF_MODEL.cfg.defaults,function(v,k){inst.attr[k]=fresh[k]||v});underscore.each(SELF_MODEL.cfg.methods,function(v,k){inst[k]=v})};return new instance};SELF_MODEL.search=function(k,v){SELF_MODEL.scope=underscore.filter(models[prop.uid].collection,function(m){return m.get(k).indexOf(v)>-1});invalidateScopedView()};SELF_MODEL.filter=function(k,v){SELF_MODEL.scope=underscore.filter(models[prop.uid].collection,function(m){return m.get(k)===v});invalidateScopedView()};SELF_MODEL.all=function(){if(SELF_MODEL.cfg.sorting){SELF_MODEL.sort(SELF_MODEL.cfg.sorting)}SELF_MODEL.scope=models[prop.uid].collection;invalidateScopedView()};SELF_MODEL.sort=function(crit){var key=underscore.keys(crit).shift();var predicate=function(m){return m.get(key)===crit[key]};models[prop.uid].collection=underscore.sortBy(models[prop.uid].collection,predicate)};SELF_MODEL.fetch=function(){fetch(SELF_MODEL)};SELF_MODEL.create=function(values,callback){var uri=HTTP.post+":"+config.api+SELF_MODEL.uid;restAdapter(SELF_MODEL.uid,uri,values,callback)};SELF_MODEL.update=function(i,values,callback){var uri=HTTP.put+":"+config.api+SELF_MODEL.uid+"/"+models[prop.uid].collection[i].get("id");restAdapter(SELF_MODEL.uid,uri,values,callback)};SELF_MODEL.delete=function(i,callback){var uri=HTTP.delete+":"+config.api+SELF_MODEL.uid+"/"+models[prop.uid].collection[i].get("id");restAdapter(SELF_MODEL.uid,uri,undefined,callback)}};var createModel=function(prop){var tmpmodel=new Model(prop);models[tmpmodel.uid]=tmpmodel;models[tmpmodel.uid].collection=[];modelData.push({uid:tmpmodel.uid,uri:config.api+tmpmodel.uid})};var createView=function(prop){var tmpview=new View(prop);views[tmpview.uid]=tmpview;viewTemplates.push({uid:tmpview.uid,uri:tmpview.path})};var fetchModel=function(uid,resp){models[uid].collection=[];underscore.each(resp,function(f){models[uid].collection.push(models[uid].construct(f))});models[uid].all()};var renderView=function(uid,html){views[uid].init(html)};var fetch=function(m){getResource(m.uid,config.api+m.uid,fetchModel)};var render=function(v){getResource(v.iud,v.path,renderView)};var listen=function(v){v.listen()};SELF_KRASNY.app=function(configuration){config.api=configuration.apihost||"/";underscore.each(configuration.models,createModel);retrieveSync(modelData,fetchModel,function(){underscore.each(configuration.views,createView);retrieveSync(viewTemplates,renderView,function(){configuration.controller(models,views,jquery,underscore);underscore.each(views,listen)})})}};if(typeof module!=="undefined")module.exports=new krasny(require("underscore"),require("jquery"));else window.K=new krasny(_,$);
